<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--

	예매 시 좌석 정보 저장(TheaterDAO.XML)
	- insertSeat(좌석,극장이름,유저아이디)
	
	이미 예약된 좌석들 리스트 가져오기(TheaterDAO.xml)
	- getBookedSeats 
	
	남은 좌석 수 가져오기 (TheaterDAO.xml)
	getLeftSeat(극장이름)

-->



<mapper namespace="com.spring.recopay.domain.TheaterDAO">
	<select id="select" resultType="com.spring.recopay.domain.TheaterDTO">
	SELECT th_uid "uid", th_id "id", th_name "name", th_location "location", th_totalseat "totalseat", th_state "state", 
	th_telno "telno", th_chartr "chartr", th_lng "lng", th_lat "lat", th_url "url", th_totalno "totalno",th_opendate "opendate"
	FROM Theater
	</select> 
	
	<select id="viewById" resultType="com.spring.recopay.domain.TheaterDTO">
	SELECT th_uid "uid", th_id "id", th_name "name", th_location "location", th_totalseat "totalseat", th_state "state", 
	th_telno "telno", th_chartr "chartr", th_lng "lng", th_lat "lat", th_url "url", th_totalno "totalno",th_opendate "opendate"
	FROM Theater where th_id = #{id}
	</select>
	
	<!-- 극장 이름 넘겨주면 지도 X,Y 좌표 가져오기  -->
	<select id="getMapCordXY" resultType="com.spring.recopay.domain.TheaterDTO">
		SELECT th_lat "lat", th_lng "lng" FROM theater WHERE th_name = #{name};
	</select>
	
	<!-- 남은 좌석 수 가져오기 -->
	<select id="getLeftSeat" resultType="com.spring.recopay.domain.TheaterDTO">
		<![CDATA[ 
			SELECT th_totalseat - (select count(*) from theater_seat where th_uid = (SELECT TH_UID FROM THEATER WHERE th_name=#{theaterName} ) "leftSeat" 
			FROM theater WHERE th_name = #{theaterName}
		]]>	
	</select>
	
	<!-- 선택한 좌석 insert -->
    <insert id="insertSeat">
		insert into Theater_Seat (seat_num , th_uid , user_uid , prf_time) values
 		 (#{param1}, (SELECT th_uid from Theater where th_name = #{param2} ) , 
    	 (SELECT user_uid from Member where user_id = #{param3}) , #{param4})
    </insert>
    
    <!-- 
		insert into Theater_Seat (seat_num , th_uid , user_uid , prf_time) values
 		 (#{seat}, (SELECT th_uid from Theater where th_name = #{theaterName} ) , 
    	 (SELECT user_uid from Member where user_id = #{userId}) , #{time})
     -->
	
	<!-- 예약된 좌석들 정보 가져오기 -->
	<select id="getAllBookedSeats" resultType="com.spring.recopay.domain.TheaterSeatDTO">
		SELECT seat_num "seat", th_uid, user_uid, prf_time "time" FROM Theater_Seat
	</select>
	
	
	
</mapper>













